@using ZeroKWeb
@using ZkData
@model Clan
@{
  var c = Model;
  var isMember = c.Accounts.Any(y => y.AccountID == Global.AccountID);
}
@Html.ActionLink("Back to clan list", "ClanList")
<h2>@c.ClanName</h2>
<table>
  <tr>
    <td>
      @{
        var infl = Model.Accounts.SelectMany(x => x.AccountPlanets);
      }
      <h3>@Html.PrintClan(c)</h3>
      <img  src='@c.GetImageUrl()'/><br />
      Influence: <b>@Html.PrintInfluence(Model, infl.Sum(x => x.Influence), infl.Sum(x => x.ShadowInfluence))</b><br />
      Credits: <b>@c.Accounts.Sum(x => x.Credits)</b><br />
      @(c.LeaderTitle ?? "leader"): @Html.PrintAccount(c.Accounts.Single(x => x.IsClanFounder))
    </td>
    <td>
      <div style='margin: 10px; font-size: 80%;'>
        @Html.BBCode(c.Description)
      </div>
    </td>
  </tr>
</table>
@if (c.CanJoin(Global.Account)) {
  @Html.ActionLink("Join this clan", "JoinClan", new { id = c.ClanID }, new { @class = "delete" })
}
<h3>Dropships</h3>
<span nowrap="nowrap">@Model.Accounts.Sum(x => x.DropshipCount)/@(Model.Accounts.Count() * GlobalConst.DefaultDropshipCapacity + Model.Accounts.SelectMany(x => x.Planets).SelectMany(x => x.PlanetStructures).Where(x => !x.IsDestroyed).Sum(x => x.StructureType.EffectDropshipCapacity))
  ready to deploy</span>
<table>
  @foreach (var p in Model.Accounts.SelectMany(x => x.AccountPlanets).GroupBy(x => x.Planet).Select(x => new { planet = x.Key, dropships = x.Sum(y => y.DropshipCount) }).Where(x => x.dropships > 0).OrderByDescending(x => x.dropships)) { 
    <tr>
      <td>@Html.PrintPlanet(p.planet)</td>
      <td>
        <img src='/img/dropship.png' />@p.dropships</td>
    </tr>
  }
</table>
@if (isMember) {
  <b>Secret topic:</b><br />
  @Html.BBCode(c.SecretTopic)
}
@if (isMember && Global.Account.HasClanRights) { //has rights
  <br />
  @Html.ActionLink("Modify clan information", "CreateClan", new { id = c.ClanID })
}
<h3>Diplomacy</h3>
<table>
@foreach (var them in new ZkDataContext().Clans.Where(x => x.ClanID != Model.ClanID)) {
  var our = c.TreatyOffersByOfferingClanID.SingleOrDefault(x => x.TargetClanID == them.ClanID) ?? new TreatyOffer();
  var their = them.TreatyOffersByOfferingClanID.SingleOrDefault(x => x.TargetClanID == c.ClanID) ?? new TreatyOffer();
  var effective = them.GetEffectiveTreaty(Model.ClanID);
  
  <tr>
  <td colspan='2'><b>@Html.PrintClan(them) - @them.ClanName<br />
   Status: @effective.AllyStatus  Research: @effective.IsResearchAgreement
   </b>
   </td>
  </tr>
  
  <tr>
  <td valign='top'>Our offer:<br />
  @if (isMember) {
    if (Global.Account.HasClanRights) {
    <form method="post" action="@Url.Action("OfferTreaty", new { targetClanID = them.ClanID })">
      Status: @Html.DropDownList("ourStatus", Enum.GetValues(typeof(AllyStatus)).OfType<AllyStatus>().Select(x => new SelectListItem() { Text = x.ToString(), Value = ((int)x).ToString(), Selected = our.AllyStatus == x }))
      Research: @Html.CheckBox("ourResearch", our.IsResearchAgreement)<input type="submit" value="offer"/><br />
      @Html.TextArea("ourMessage", our.OfferingClanMessage, new { rows = 2, cols = 30 })
    </form>
    } else { 
    <span>
      Status: @our.AllyStatus  Research: @our.IsResearchAgreement<br />
      @our.OfferingClanMessage<br />
    </span>
    }
  } else { 
    <span>
      Status: @our.AllyStatus  Research: @our.IsResearchAgreement<br />
    </span>
  }
  </td>
  <td valign='top'>Their offer:<br />
    <span>
      Status: @their.AllyStatus  Research: @their.IsResearchAgreement<br />
    </span>
  </td>
  </tr>  
}
</table>


<h3>Members</h3>
<table>
  <th>Name </th>
  <th>Influence </th>
  <th>Credits </th>
  <th></th>
  <th></th>
  @foreach (var a in c.Accounts.OrderByDescending(x => x.AccountPlanets.Sum(y => y.Influence + y.ShadowInfluence))) {
    <tr>
      <td>
        @Html.PrintAccount(a)
      </td>
      <td>
        @Html.PrintInfluence(Model, a.AccountPlanets.Sum(x => x.Influence), a.AccountPlanets.Sum(x => x.ShadowInfluence))
      </td>
      <td>@a.Credits
      </td>
      <td>
        @{
     var role = "";
     if (a.IsClanFounder) { role = "F"; } else if (a.HasClanRights) { role = "R"; }
        }
        @role
      </td>
      <td>
        @if (isMember && Global.Account.HasClanRights && !a.IsClanFounder) { //has rights
          @:&nbsp
          // todo: disallow kicking after the round starts
          var question = String.Format("Expelling {0} will make him sad. Are you sure you want to proceed?", a.Name);
          @Html.ActionLink("kick", "KickPlayerFromClan", new { clanID = c.ClanID, accountID = a.AccountID }, new { @onclick = String.Format("return confirm('{0}')", question) }) @:|@Html.ActionLink(a.HasClanRights ? "rights" : "rights", "ChangePlayerRights", new { clanID = c.ClanID, accountID = a.AccountID })
                                                                                                                
        }
      </td>
    </tr>
        foreach (var p in a.Planets) {
    <tr>
      <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<small>@Html.PrintPlanet(p)</small> </td>
      <td>&nbsp;&nbsp;&nbsp;<small>@Html.PrintInfluence(a.AccountPlanets.Single(x => x.Planet == p))</small> </td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
        }

  }
</table>
<h3>Clan technologies</h3>
@foreach (var unlock in Galaxy.ClanUnlocks(new ZkDataContext(), Model.ClanID)) {
  <span style="color: @unlock.LabelColor; font-size:x-small; display:inline-block; width:90px;height:90px" title="$unlock$@unlock.UnlockID"  >
    <img src="@unlock.ImageUrl"/><br />
    @unlock.Name
  </span>
}
<h3>@Model.Shortcut events</h3>
@Html.Action("Events", new { clanID = c.ClanID, partial = true })
<br />
@Html.ActionLink("Back to clan list", "ClanList")
<hr />
@if (isMember) {
  Html.RenderPartial("CommentList", new ZeroKWeb.Models.CommentList() { Thread = Model.ForumThread, ActionData = new { clanID = c.ClanID, threadID = Model.ForumThreadID } });
}
