@using ZeroKWeb
@using ZkData
@model ZkData.Galaxy
@{
  Page.Title = "Planet-Wars galaxy view";
  ViewBag.Minimal = true;
  var g = Model;

  int maxDropships = new ZkDataContext().AccountPlanets.GroupBy(x => x.PlanetID).Select(x => (int?)x.Sum(y=>y.DropshipCount)).Max() ?? 1; // fake max as 1 to prevent division by zero
  if (maxDropships == 0) {
    maxDropships = 1;
  }
}

@if (Global.IsAccountAuthorized) {
 <span>
  Clan: @Html.PrintClan(Global.Clan) | Credits: @Global.Account.Credits | Influence: @Html.PrintInfluence(Global.Clan, Global.Account.AccountPlanets.Sum(x => (int?)x.Influence) ?? 0, Global.Account.AccountPlanets.Sum(x => (int?)x.ShadowInfluence) ?? 0) | 
 </span>
}
<span>
  @Html.ActionLink("Clans", "ClanList") | @Html.ActionLink("Events","Events") | turn: @Model.Turn | galaxy started: @Model.Started | <a href='/Wiki/PlanetWarsDesign'>Help/info</a> | <a href='/Forum?categoryID=9'>Forums</a>
</span>

<span style='color:red; font-size:bigger'>WARNING, THIS IS BETA!</span>
<div style="text-align: left; border: 0; position: relative">
  <img src="/img/galaxies/render_@(g.GalaxyID).jpg"" style="text-align:left; z-index:-50; " width="@Model.Width" height="@Model.Height"/>
  @foreach (var p in Model.Planets) {
    var pr = p.PlanetRectangle(Model);
    Clan clan = null;
    Clan secondClan = null;
    var secondClanInfluence = 0;

    int shipCount = p.AccountPlanets.Sum(x => (int?)x.DropshipCount) ?? 0;

    if (p.Account != null) {
      clan = p.Account.Clan;
    }

    var secondRatio = 0.0;
    var entry = p.AccountPlanets.GroupBy(x => x.Account.Clan).Where(x => x.Key != null && x.Key != clan).OrderByDescending(x => x.Sum(y => y.Influence + y.ShadowInfluence)).FirstOrDefault();
    if (clan != null && entry != null) {
      secondClan = entry.Key;
      secondClanInfluence = entry.Sum(y => y.Influence + y.ShadowInfluence);
      var ipToCapture = p.GetIPToCapture();
      if (secondClanInfluence > 0 && (ipToCapture - secondClanInfluence) < 500) {
        secondRatio = 1.0 - (ipToCapture - secondClanInfluence) / 500.0;
      }
    }
    
    
    <table cellpadding="0" cellspacing="0" style="left: @(pr.Left - 40)px; top: @(pr.Top - 50)px; width:@(pr.Width + 80)px; height:50px;" class="pwlabel" width="@(pr.Width + 80)" height="50">
      <tr>
        <td valign="bottom" align="center">
          <a href='@Url.Action("Planet", new { id = p.PlanetID })' style='color:White'><span title="$planet$@p.PlanetID" style="color: @(Clan.TreatyColor(Global.Clan, clan))" >@p.Name<br />
            @if (clan != null && Global.Clan != null && clan.ClanID == Global.Clan.ClanID) {
              <span style="font-size: 8px">@p.Account.Name</span>
            }
          </span></a>
        </td>
      </tr>
    </table>
    
    <span style="position: absolute; left: @(pr.Left - 20)px; top: @(pr.Top)px; width: 20px; height: @(pr.Height)px; text-align:right;" title='$planetInfluence$@p.PlanetID'>
      <table cellpadding="0" cellspacing="0" style="font-size: 2px;">
        <tr>
          <td>
            @if (clan != null) {
              <img src='@clan.GetImageUrl()' width='20' />
            }
          </td>
        </tr>
        <tr>
          <td>
            @if (secondRatio > 0) {
              <img src='@secondClan.GetImageUrl()' width='@(Math.Round(20.0 * secondRatio))' />
            }
          </td>
        </tr>
      </table>
    </span>
    
    <a href='@Url.Action("Planet", new { id = p.PlanetID })' style='color:White' title='$planet$@p.PlanetID'><span style="position: absolute; left: @(pr.Left)px; top: @(pr.Top)px; width: @(pr.Width)px; height: @(pr.Height)px;" title='$planet$@p.PlanetID'>
      @foreach (var s in p.PlanetStructures) {
        <img src='@s.GetImageUrl()' width='@(pr.Width)' style='position:absolute' />
      }
    </span></a>
    
    
      if (shipCount > 0) {
    <span style="position: absolute; left: @(pr.Right)px; top: @(pr.Top)px; width: 100px; height: @(pr.Height)px; display:inline-block;" title='$planetDropships$@p.PlanetID'>
      <img src='/img/fleets/war.png' width='@(Math.Round(25.0 * shipCount / (double)maxDropships))' /><span
        style="font-size: 10px">@shipCount</span> </span>
      }
  }
</div>
<h3>Last events</h3>
<span style='float:left'>
@Html.Action("Events", new { partial = true, pageSize = 40 })</span> <span><img  src='http://3.bp.blogspot.com/_YTJBDUN8iSE/TSjDkNEwJAI/AAAAAAAAD0o/N8w-cy_J_EM/s1600/Tracy_Caldwell_Dyson_in_Cupola_ISS.jpg'
  width='600' /><br /> This is BETA, pelase forgive and report issues :-)</span>


